<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Шахматная задача — мат королевой + анимация</title>
<style>
  :root{
    --light:#f0d9b5;
    --dark:#b58863;
    --board-size:min(84vmin,720px);
    --accent: rgba(255,200,110,0.9);
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg,#071226 0%, #031020 100%);
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    color:#eaf4ff;
  }

  /* container holds either the board or the scene */
  .frame{
    width:var(--board-size);
    max-width:95vw;
    border-radius:14px;
    overflow:hidden;
    position:relative;
    box-shadow: 0 30px 80px rgba(2,6,23,0.7);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
  }

  /* BOARD */
  .board{
    width:100%;
    display:grid;
    grid-template-columns: repeat(8,1fr);
    border-radius:8px;
    overflow:hidden;
    touch-action: manipulation;
  }
  .square{
    aspect-ratio: 1/1;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    -webkit-user-select:none;
    transition: background 160ms ease, transform 120ms ease;
    position:relative;
  }
  .square.light{ background: var(--light); }
  .square.dark{ background: var(--dark); }
  .square.highlight{ box-shadow: inset 0 0 0 6px rgba(255,200,110,0.16); }
  .square.invalid{ animation: shake 360ms ease; }
  @keyframes shake {
    0%{ transform: translateX(0) } 25%{ transform: translateX(-6px) } 50%{ transform: translateX(6px) } 75%{ transform: translateX(-4px) } 100%{ transform: translateX(0) }
  }

  .piece {
    width:78%;
    height:78%;
    display:block;
    pointer-events:none;
    filter: drop-shadow(0 12px 18px rgba(2,6,23,0.45));
    transition: transform 140ms ease;
  }
  /* small indicator for selectable */
  .select-hint{
    position:absolute;
    right:6px; bottom:6px;
    width:12px; height:12px;
    border-radius:50%;
    background:var(--accent);
    box-shadow:0 6px 12px rgba(255,180,90,0.08);
    opacity:0.0;
    transform:scale(0.8);
    transition:opacity 180ms, transform 180ms;
  }
  .square.source .select-hint{ opacity:1; transform:scale(1); }

  /* scene (hidden until trigger) */
  .scene{
    width:100%;
    height:calc(var(--board-size) * 1);
    background:#000;
    display:none;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }
  .scene svg{ width:100%; height:100%; display:block; }

  /* fade transitions */
  .fadeOut{
    animation: fadeOut 420ms forwards;
  }
  @keyframes fadeOut {
    to { opacity:0; transform: scale(0.99); }
  }

  /* quick accessible reset (small, unobtrusive) */
  .reset {
    position:absolute;
    right:10px;
    top:10px;
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.05);
    color:#eaf4ff;
    padding:6px 8px;
    border-radius:8px;
    font-size:12px;
    cursor:pointer;
    z-index:40;
  }

  /* mobile tweak to ensure board is comfortable */
  @media (max-width:460px){
    :root{ --board-size:94vmin; }
  }
</style>
</head>
<body>

<div class="frame" id="frame">
  <button id="resetBtn" class="reset" title="Reset">Reset</button>

  <!-- BOARD area -->
  <div id="boardArea">
    <div id="board" class="board" aria-hidden="false"></div>
  </div>

  <!-- SCENE area (hidden until move) -->
  <div id="scene" class="scene" aria-hidden="true"></div>
</div>

<script>
/* Single-file implementation.
   Position:
     White: Kg6, Qh6
     Black: Kg8, pg7
   Correct move: Qxg7# (queen from h6 to g7). After move, board disappears and scene runs.
*/

/* --- Utilities --- */
const files = ['a','b','c','d','e','f','g','h'];
const ranks = [8,7,6,5,4,3,2,1];
const frame = document.getElementById('frame');
const boardEl = document.getElementById('board');
const boardArea = document.getElementById('boardArea');
const sceneEl = document.getElementById('scene');
const resetBtn = document.getElementById('resetBtn');

let state = { moving:false, selected:null };

/* --- Pieces: use clear SVG Staunton-like shapes (line-art for scene; filled for board) --- */

/* Board pieces definitions (recognizable shapes) */
let pieces = {
  'g6': {side:'w',type:'king'},
  'h6': {side:'w',type:'queen'},
  'g8': {side:'b',type:'king'},
  'g7': {side:'b',type:'pawn'}
};

const source = 'h6';
const target = 'g7';

/* Create board */
function makeBoard(){
  boardEl.innerHTML = '';
  for(let r=0;r<8;r++){
    for(let f=0;f<8;f++){
      const sq = files[f] + ranks[r];
      const cell = document.createElement('div');
      cell.className = 'square ' + (((f + r) % 2 === 0) ? 'light' : 'dark');
      cell.dataset.sq = sq;
      cell.addEventListener('click', onCellClick);
      // place piece if exists
      if(pieces[sq]){
        const wrapper = document.createElement('div');
        wrapper.innerHTML = boardPieceSVG(pieces[sq].side, pieces[sq].type);
        const svg = wrapper.firstElementChild;
        svg.classList.add('piece');
        cell.appendChild(svg);
        // if source, allow select
        if(sq === source && pieces[sq].type === 'queen'){
          cell.classList.add('source');
          const hint = document.createElement('div');
          hint.className='select-hint';
          cell.appendChild(hint);
          svg.style.cursor='pointer';
          svg.addEventListener('click', (e)=>{
            e.stopPropagation();
            selectSource(sq);
          });
        }
      }
      boardEl.appendChild(cell);
    }
  }
}

/* Board piece SVG (filled, clear) */
function boardPieceSVG(side, type){
  // white pieces are light stroke/dark fill; black are dark fill
  if(type === 'king'){
    if(side === 'w'){
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(10,8)" fill="#ffffff" stroke="#101418" stroke-width="1.6">
    <rect x="52" y="6" width="6" height="18" rx="1.5" fill="#fff"/>
    <circle cx="56" cy="30" r="9" fill="#fff"/>
    <path d="M18 48 C36 18, 76 18, 98 48 L92 78 L24 78 Z" fill="#fff"/>
    <rect x="26" y="78" width="62" height="10" rx="4" fill="#fff"/>
  </g>
</svg>`;
    } else {
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(10,8)" fill="#1b2731" stroke="#061019" stroke-width="1.6">
    <rect x="52" y="6" width="6" height="18" rx="1.5" />
    <circle cx="56" cy="30" r="9" />
    <path d="M18 48 C36 18, 76 18, 98 48 L92 78 L24 78 Z" />
    <rect x="26" y="78" width="62" height="10" rx="4" />
  </g>
</svg>`;
    }
  }
  if(type === 'queen'){
    if(side === 'w'){
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(8,6)" fill="#ffffff" stroke="#101418" stroke-width="1.4">
    <path d="M16 56 C36 18, 84 18, 104 56 L92 86 L28 86 Z" fill="#fff"/>
    <circle cx="26" cy="28" r="5" fill="#fff"/>
    <circle cx="56" cy="18" r="6" fill="#fff"/>
    <circle cx="86" cy="28" r="5" fill="#fff"/>
    <rect x="30" y="86" width="52" height="10" rx="4" fill="#fff"/>
  </g>
</svg>`;
    } else {
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(8,6)" fill="#1b2731" stroke="#061019" stroke-width="1.4">
    <path d="M16 56 C36 18, 84 18, 104 56 L92 86 L28 86 Z" />
    <circle cx="26" cy="28" r="5" />
    <circle cx="56" cy="18" r="6" />
    <circle cx="86" cy="28" r="5" />
    <rect x="30" y="86" width="52" height="10" rx="4" />
  </g>
</svg>`;
    }
  }
  if(type === 'pawn'){
    if(side === 'w'){
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(12,12)" fill="#ffffff" stroke="#101418" stroke-width="1.2">
    <circle cx="36" cy="22" r="9" fill="#fff"/>
    <rect x="18" y="40" width="36" height="16" rx="4" fill="#fff"/>
  </g>
</svg>`;
    } else {
      return `
<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <g transform="translate(12,12)" fill="#1b2731" stroke="#061019" stroke-width="1.2">
    <circle cx="36" cy="22" r="9" />
    <rect x="18" y="40" width="36" height="16" rx="4" />
  </g>
</svg>`;
    }
  }
  return '';
}

/* Select source */
function selectSource(sq){
  if(state.moving) return;
  state.selected = sq;
  state.moving = true;
  document.querySelectorAll('.square').forEach(c => c.classList.remove('highlight'));
  const srcEl = document.querySelector(`[data-sq="${sq}"]`);
  const tgtEl = document.querySelector(`[data-sq="${target}"]`);
  if(srcEl) srcEl.classList.add('highlight');
  if(tgtEl) tgtEl.classList.add('highlight');
}

/* Cell click handler */
function onCellClick(e){
  const sq = e.currentTarget.dataset.sq;
  if(!state.moving){
    // indicate need to select queen first
    e.currentTarget.classList.add('invalid');
    setTimeout(()=> e.currentTarget.classList.remove('invalid'),360);
    return;
  }
  if(state.selected !== source){
    state.moving = false;
    state.selected = null;
    return;
  }
  if(sq === target){
    // perform move animation, capture, then scene
    moveQueen(source, target, () => {
      // update pieces
      delete pieces[source];
      delete pieces[target]; // captured pawn
      pieces[target] = {side:'w',type:'queen'};
      // remove board visually then start scene
      startTransitionToScene();
    });
  } else {
    // wrong square
    e.currentTarget.classList.add('invalid');
    setTimeout(()=> e.currentTarget.classList.remove('invalid'),360);
  }
}

/* Animate queen move visually by cloning element */
function moveQueen(from, to, cb){
  const fromEl = document.querySelector(`[data-sq="${from}"]`);
  const toEl = document.querySelector(`[data-sq="${to}"]`);
  if(!fromEl || !toEl){ if(cb) cb(); return; }
  const piece = fromEl.querySelector('.piece');
  if(!piece){ if(cb) cb(); return; }
  const clone = piece.cloneNode(true);
  clone.style.position='absolute';
  const bRect = boardEl.getBoundingClientRect();
  const fRect = fromEl.getBoundingClientRect();
  clone.style.left = (fRect.left - bRect.left) + 'px';
  clone.style.top  = (fRect.top  - bRect.top) + 'px';
  clone.style.width = fRect.width + 'px';
  clone.style.height= fRect.height + 'px';
  clone.style.zIndex = 999;
  clone.style.transition = 'all 420ms cubic-bezier(.2,.95,.2,1)';
  boardEl.appendChild(clone);
  // remove original
  const orig = fromEl.querySelector('.piece');
  if(orig) orig.parentElement.remove();
  const tRect = toEl.getBoundingClientRect();
  requestAnimationFrame(()=>{
    clone.style.left = (tRect.left - bRect.left) + 'px';
    clone.style.top  = (tRect.top - bRect.top) + 'px';
    clone.style.transform = 'scale(1.02)';
  });
  setTimeout(()=>{ clone.remove(); if(cb) cb(); },480);
}

/* Transition: hide board then show scene */
function startTransitionToScene(){
  // fade out board area
  boardArea.classList.add('fadeOut');
  setTimeout(()=> {
    boardArea.style.display='none';
    runScene(); // start scene
  },420);
}

/* Reset */
resetBtn.addEventListener('click', ()=>{
  // restore pieces and show board
  pieces = {
    'g6': {side:'w',type:'king'},
    'h6': {side:'w',type:'queen'},
    'g8': {side:'b',type:'king'},
    'g7': {side:'b',type:'pawn'}
  };
  state = { moving:false, selected:null };
  boardArea.style.display='';
  boardArea.classList.remove('fadeOut');
  sceneEl.style.display='none';
  sceneEl.innerHTML='';
  makeBoard();
});

/* ========== SCENE: linear white-line animation on black background ==========
   - purely white vector lines on black
   - queen (tall), draws sword, sudden swift motion, crown flies, king falls
   - no text, no UI. Single timeline controlled in JS.
==============================================================*/

function runScene(){
  sceneEl.style.display='flex';
  sceneEl.innerHTML = `
<svg viewBox="0 0 1280 720" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <defs>
    <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="2" result="b"/>
      <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#ffffff" stop-opacity="0.98"/><stop offset="1" stop-color="#ffffff" stop-opacity="0.92"/></linearGradient>
  </defs>

  <rect width="100%" height="100%" fill="#000"/>

  <!-- background speedlines -->
  <g id="speed" opacity="0">
    <g stroke="#fff" stroke-opacity="0.06" stroke-width="6" stroke-linecap="round">
      <path d="M40 0 L420 720" />
      <path d="M120 0 L500 720" stroke-width="8"/>
      <path d="M200 0 L580 720" />
      <path d="M300 0 L680 720" stroke-width="5"/>
    </g>
  </g>

  <!-- hero: queen in left (white strokes) -->
  <g id="queen" transform="translate(300,360)">
    <!-- body outline -->
    <g id="qBody" stroke="#fff" stroke-width="3" fill="none" stroke-linejoin="round" stroke-linecap="round">
      <path d="M-40 44 C-20 -36, 20 -36, 40 44 L40 92 L-40 92 Z" />
      <circle cx="0" cy="-62" r="16" />
      <path d="M-18 -56 Q0 -42 18 -56" stroke-width="2" />
    </g>
    <!-- sword (hidden drawn at hand then pulled) -->
    <g id="sword" transform="translate(46,-18) rotate(-36)">
      <rect x="-8" y="-6" width="180" height="12" rx="6" fill="#fff" opacity="0"/> 
      <rect x="178" y="-2" width="46" height="8" rx="4" fill="#fff" opacity="0"/>
    </g>
    <!-- cloak lines for anime motion -->
    <g id="cloak" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.0">
      <path d="M-34 34 C-12 -6, 12 -6, 34 34" />
      <path d="M-28 64 Q0 36 28 64" />
    </g>
  </g>

  <!-- king on right -->
  <g id="king" transform="translate(880,320)">
    <g id="kBody" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <rect x="-28" y="-80" width="56" height="112" rx="6" />
      <circle cx="0" cy="-100" r="14" />
      <path id="crown" d="M-22 -126 L-12 -138 L0 -126 L12 -138 L22 -126" stroke-width="3" fill="none" />
    </g>
  </g>

  <!-- crown flying (separate) -->
  <g id="crownFly" opacity="0">
    <path d="M0 0 L10 -12 L22 0 L10 -6 Z" stroke="#fff" stroke-width="3" fill="none" transform="translate(880,194)"/>
  </g>

  <!-- impact flare -->
  <g id="impact" opacity="0">
    <circle cx="720" cy="300" r="0" fill="#fff" opacity="0.95"/>
  </g>

</svg>
  `;

  // grab elements
  const svg = sceneEl.querySelector('svg');
  const speed = svg.getElementById('speed');
  const queen = svg.getElementById('queen');
  const sword = svg.getElementById('sword');
  const cloak = svg.getElementById('cloak');
  const king = svg.getElementById('king');
  const crownFly = svg.getElementById('crownFly');
  const impact = svg.getElementById('impact');

  // timeline (ms)
  const t0 = 200;
  const t1 = 600;
  const t2 = 1000;
  const t3 = 1300;
  const t4 = 1700;
  const t5 = 2200;
  const t6 = 3000;

  // 0) idle: subtle bob handled via animation
  queen.animate([
    { transform: 'translate(300px,360px) translateY(0px)' },
    { transform: 'translate(300px,360px) translateY(-6px)' },
    { transform: 'translate(300px,360px) translateY(0px)' }
  ], { duration: 900, iterations: Infinity, easing: 'ease-in-out' });

  // 1) reveal sword & cloak (draw)
  setTimeout(()=>{
    // sword fill in (draw as solid then become visible)
    const swordRects = sword.querySelectorAll('rect');
    swordRects.forEach(r => r.style.transition = 'opacity 220ms ease');
    swordRects.forEach(r => r.style.opacity = '1');

    cloak.style.transition = 'opacity 260ms ease';
    cloak.style.opacity = '1';
  }, t1);

  // 2) speedlines appear (charge)
  setTimeout(()=>{
    speed.style.transition = 'opacity 160ms linear';
    speed.style.opacity = '1';
    // lean forward small
    queen.animate([
      { transform: 'translate(300px,360px) translateX(0)' },
      { transform: 'translate(330px,350px) scale(1.02)' }
    ], { duration: 320, fill:'forwards', easing:'cubic-bezier(.15,.9,.25,1)' });
  }, t2);

  // 3) sword lunges across (fast)
  setTimeout(()=>{
    sword.animate([
      { transform: 'translate(46px,-18px) rotate(-36deg)' },
      { transform: 'translate(220px,-70px) rotate(18deg)' },
      { transform: 'translate(420px,-100px) rotate(36deg)' }
    ], { duration: 400, easing:'cubic-bezier(.12,.95,.2,1)', fill:'forwards' });

    // impact flare
    const circle = impact.querySelector('circle');
    impact.style.transition='opacity 80ms linear';
    impact.style.opacity='1';
    circle.animate([{ r:0, opacity:0.9 }, { r:160, opacity:0.98 }], { duration: 380, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards' });

    // camera subtle zoom/shake
    svg.animate([{ transform:'scale(1)' }, { transform:'scale(1.03)' }, { transform:'scale(1)' }], { duration: 900, easing:'ease-out', fill:'forwards' });

  }, t3);

  // 4) crown flies, king topples
  setTimeout(()=>{
    // crown fly: animate transform from crown pos to a vector
    crownFly.style.transition='opacity 120ms linear';
    crownFly.style.opacity='1';
    crownFly.animate([
      { transform: 'translate(0,0) rotate(0deg)', opacity:1 },
      { transform: 'translate(120,-120) rotate(28deg)', opacity:0 }
    ], { duration: 900, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards' });

    // king falls: translate+rotate
    king.animate([
      { transform: 'translate(880px,320px) rotate(0deg)', opacity:1 },
      { transform: 'translate(920px,460px) rotate(72deg)', opacity:0.96 }
    ], { duration: 900, easing:'cubic-bezier(.2,.9,.2,1)', fill:'forwards' });

    // fade speedlines and impact
    speed.style.transition='opacity 360ms linear';
    speed.style.opacity='0';
    impact.style.transition='opacity 360ms linear';
    impact.style.opacity='0';
  }, t4);

  // 5) end: hold dramatic pose (leave scene)
  setTimeout(()=>{
    // slow fade of queen lines to leave a finished frame (optional subtle)
    queen.animate([{ opacity:1 }, { opacity:1 }], { duration: 900 });
  }, t5);

  // final cleanup: nothing else shown; scene stays
  setTimeout(()=> {
    // keep scene displayed; user can click reset to return
  }, t6);

}

/* initialize */
makeBoard();

</script>
</body>
</html>
